<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Monitor • Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <aside class="sidebar">
    <div class="logo">SmartMonitor</div>
    <nav>
      <a href="/" class="active">Dashboard</a>
      <a href="/analytics">Analytics</a>
      <a href="/settings">Settings</a>
    </nav>
  </aside>

  <main class="main">
    <header>
      <h1>Dashboard</h1>
    </header>
    <div id="co2-warning" style="display:none; background:#ff4e4e; color:white; padding:1em; text-align:center; margin-bottom:1em; border-radius:6px;">
      Warning: CO₂ is above your safe threshold!
    </div>
    <div id="posture-warning" style="display:none; background:#ff9800; color:white; padding:1em; text-align:center; margin-bottom:1em; border-radius:6px;">
      Warning: Bad posture detected! Please adjust your sitting position.
    </div>

    <!-- Status Cards -->
    <section class="cards">
      <div class="card">
        <div class="title">Desk Occupied</div>
        <div class="value" id="desk-status">—</div>
      </div>
      <div class="card">
        <div class="title">CO₂ Level</div>
        <div class="value" id="co2-level">— ppm</div>
      </div>
      <div class="card">
        <div class="title">Room Temp</div>
        <div class="value" id="room-temp">— °C</div>
      </div>
      <div class="card">
        <div class="title">Lights</div>
        <div class="value" id="light-status">—</div>
      </div>
      <div class="card">
        <div class="title">Outdoor Temp</div>
        <div class="value" id="outdoor-temp">— °C</div>
      </div>
      <div class="card">
        <div class="title">Outdoor AQI</div>
        <div class="value" id="outdoor-aqi">—</div>
      </div>
    </section>
    <button id="refresh-dashboard" style="margin-bottom:1rem;">Refresh</button>

    <!-- Charts -->
    <section class="charts">
      <div class="chart-card">
        <h2>CO₂ Trend (1h)</h2>
        <canvas id="chart-co2"></canvas>
      </div>
      <div class="chart-card">
        <h2>Occupancy Timeline</h2>
        <canvas id="chart-occ"></canvas>
      </div>
    </section>
  </main>

  <script>
    let settings = {};

    async function loadDashboard() {
      try {
        // Fetch settings and dashboard data in parallel
        const [settingsRes, dataRes] = await Promise.all([
          fetch('/api/settings'),
          fetch('/api/dashboard-data')
        ]);
        settings = await settingsRes.json();
        const data = await dataRes.json();

        document.getElementById('desk-status').textContent = data.deskOccupied ? 'Yes' : 'No';
        document.getElementById('co2-level').textContent = data.co2 + ' ppm';
        document.getElementById('room-temp').textContent = data.roomTemp + ' °C';
        document.getElementById('light-status').textContent = data.lightOn ? 'On' : 'Off';
        document.getElementById('outdoor-temp').textContent = data.outdoorTemp + ' °C';
        document.getElementById('outdoor-aqi').textContent = data.outdoorAqi;

        // Update or create CO₂ Trend chart
        if (window.co2Chart) {
          window.co2Chart.data.datasets[0].data = data.co2Trend;
          window.co2Chart.update();
        } else {
          window.co2Chart = new Chart(
            document.getElementById('chart-co2').getContext('2d'),
            {
              type: 'line',
              data: {
                labels: ['50m','40m','30m','20m','10m','Now'],
                datasets: [{
                  data: data.co2Trend,
                  borderColor: '#4e5dff',
                  backgroundColor: 'rgba(78,93,255,0.2)'
                }]
              },
              options: { plugins:{legend:{display:false}}, scales:{x:{display:true, title: { display: true, text: 'Minutes Ago' }}, y: {display: true,title: { display: true, text: 'CO₂ (ppm)' }} } }
            }
          );
        }

        // Update or create Occupancy Timeline chart
        if (window.occChart) {
          window.occChart.data.datasets[0].data = data.occTimeline;
          window.occChart.update();
        } else {
          window.occChart = new Chart(
            document.getElementById('chart-occ').getContext('2d'),
            {
              type: 'bar',
              data: {
                labels: ['50m','40m','30m','20m','10m','Now'],
                datasets: [{
                  data: data.occTimeline,
                  borderColor: '#4e5dff',
                  backgroundColor: 'rgba(78,93,255,0.2)'
                }]
              },
              options: { plugins:{legend:{display:false}}, scales:{x:{display:true, title: { display: true, text: 'm' }}, y: {display: true,title: { display: true, text: 'n' }} } }
            }
          );
        }
      } catch (err) {
        console.error('Failed to load dashboard data:', err);
      }
    }

    // Initial load
    loadDashboard();

    // Auto-refresh every 10 seconds
    setInterval(loadDashboard, 10000);

    // Add refresh button handler
    document.getElementById('refresh-dashboard').addEventListener('click', loadDashboard);
  </script>

  <script src="app.js"></script>
</body>
</html>
