<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Monitor • Analytics</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <aside class="sidebar">
    <div class="logo">SmartMonitor</div>
    <nav>
      <a href="/">Dashboard</a>
      <a href="/analytics" class="active">Analytics</a>
      <a href="/settings">Settings</a>
    </nav>
  </aside>

  <main class="main">
    <header><h1>Analytics</h1></header>

    <!-- Summary Metrics -->
    <section class="analytics-metrics">
      <div class="card">
        <div class="title">Total Exits</div>
        <div class="value" id="total-exits">—</div>
      </div>
      <div class="card">
        <div class="title">Avg Break (min)</div>
        <div class="value" id="avg-break">—</div>
      </div>
      <div class="card">
        <div class="title">% Good Posture</div>
        <div class="value" id="posture-ok">—%</div>
      </div>
      <div class="card">
        <div class="title">Avg CO₂ (ppm)</div>
        <div class="value" id="avg-co2">—</div>
      </div>
    </section>

    <!-- Break-duration-over-time Chart -->
    <div 
      class="analytics-chart" 
      style="display:flex; flex-direction:column; height:350px; margin-bottom:2rem;"
    >
      <h2>Break Duration by Minute (last 10 min)</h2>
      <canvas 
        id="chart-break" 
        style="width:100%; flex:1; height:100%;"
      ></canvas>
    </div>

    <button id="refresh-analytics">Refresh</button>
  </main>

  <script>
    let breakChart;

    async function loadAnalytics() {
      try {
        const res = await fetch('/api/analytics-data');
        if (!res.ok) throw new Error('API error');
        const json = await res.json();

        // metrics
        document.getElementById('total-exits').textContent = json.totalExits;
        document.getElementById('avg-break').textContent   = json.avgBreak;
        document.getElementById('posture-ok').textContent  = json.postureOk + '%';
        document.getElementById('avg-co2').textContent     = json.avgCO2;

        // chart
        const labels = json.chart.labels;
        const data   = json.chart.breakDurations;
        if (breakChart) {
          breakChart.data.labels = labels;
          breakChart.data.datasets[0].data = data;
          breakChart.update();
        } else {
          const ctx = document.getElementById('chart-break').getContext('2d');
          breakChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                data,
                borderColor: 'var(--accent)',
                backgroundColor: 'rgba(78,93,255,0.2)',
                fill: true,
                tension: 0.3
              }]
            },
            options: {
              plugins: { legend: { display: false } },
              scales: {
                x: { title: { display: true, text: 'Time (HH:MM)' } },
                y: { title: { display: true, text: 'Break (min)' } }
              },
              maintainAspectRatio: false
            }
          });
        }
      } catch (e) {
        console.error('Analytics load error:', e);
      }
    }

    document.getElementById('refresh-analytics').onclick = loadAnalytics;
    loadAnalytics();
  </script>
</body>
</html>
